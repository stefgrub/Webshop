services:
  db:
    image: postgres:16
    container_name: webshop_db
    environment:
      POSTGRES_DB_FILE: /run/secrets/db_name
      POSTGRES_USER_FILE: /run/secrets/db_user
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
      TZ: Europe/Vienna
    secrets: [db_password, db_user, db_name]
    volumes:
      - db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "export PGPASSWORD=$(cat /run/secrets/db_password) && pg_isready -U $(cat /run/secrets/db_user) -d $(cat /run/secrets/db_name) -h 127.0.0.1 -p 5432"]
      interval: 10s
      timeout: 5s
      retries: 20
    restart: unless-stopped
    networks: [webshop_net]

  app:
    build: .
    container_name: webshop_app
    environment:
      TZ: Europe/Vienna
      SPRING_PROFILES_ACTIVE: "prod"

      # Branding / App-URLs
      APP_BRAND_NAME: "ViewWebshop"
      APP_BRAND_DOMAIN: "viewwebshop.at"
      APP_BASE_URL: "https://viewwebshop.at"

      # Absender / Mail
      APP_MAIL_FROM: "support@viewwebshop.at"
      APP_MAIL_FROM_NAME: "ViewWebshop"
      APP_MAIL_REPLY_TO: "support@viewwebshop.at"

      # SMTP (falls du MAIL_USER / MAIL_PASS per .env setzt)
      SPRING_MAIL_HOST: "smtp.world4you.com"
      SPRING_MAIL_PORT: "587"
      SPRING_MAIL_USERNAME: "${MAIL_USER}"
      SPRING_MAIL_PASSWORD: "${MAIL_PASS}"
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH: "true"
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE: "true"
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_REQUIRED: "true"
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_CONNECTIONTIMEOUT: "10000"
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_TIMEOUT: "10000"
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_WRITETIMEOUT: "10000"
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_SSL_TRUST: "smtp.world4you.com"

      # Spring: Secrets-Ordner als configtree einbinden
      SPRING_CONFIG_IMPORT: "optional:configtree:/run/secrets/"

      # DB: Werte aus configtree (doppelte $ verhindern Compose-Interpolation)
      SPRING_DATASOURCE_URL: "jdbc:postgresql://db:5432/$${db_name}"
      SPRING_DATASOURCE_USERNAME: "$${db_user}"
      SPRING_DATASOURCE_PASSWORD: "$${db_password}"

      # Flyway & Actuator
      SPRING_FLYWAY_ENABLED: "true"
      SPRING_FLYWAY_LOCATIONS: "classpath:db/migration"
      SPRING_FLYWAY_DEFAULT_SCHEMA: "public"
      SPRING_FLYWAY_SCHEMAS: "public"
      SPRING_FLYWAY_OUT_OF_ORDER: "true"
      SPRING_FLYWAY_BASELINE_ON_MIGRATE: "false"
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: "health,info"
      MANAGEMENT_ENDPOINT_HEALTH_PROBES_ENABLED: "true"
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: "never"

    secrets:
      - db_password
      - db_user
      - db_name

    depends_on:
      db:
        condition: service_healthy

    # Hinweis: Dein Basis-Image braucht curl oder wget fÃ¼r den Healthcheck!
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8080/actuator/health >/dev/null 2>&1 || wget -qO- http://127.0.0.1:8080/actuator/health >/dev/null 2>&1 || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 90s

    restart: unless-stopped
    networks: [webshop_net]

  caddy:
    image: caddy:2
    container_name: caddy
    depends_on:
      app:
        condition: service_healthy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddydata:/data
      - caddyconfig:/config
    environment:
      TZ: Europe/Vienna
    restart: unless-stopped
    networks: [webshop_net]

secrets:
  db_password:
    file: ./secrets/db_password.txt
  db_user:
    file: ./secrets/db_user.txt
  db_name:
    file: ./secrets/db_name.txt

volumes:
  db_data:
  caddydata:
  caddyconfig:

networks:
  webshop_net:
    driver: bridge